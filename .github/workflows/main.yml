name: Build Model Docker Image

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'HuggingFace model name (e.g., huihui-ai/Huihui-Qwen3-14B-abliterated-v2)'
        required: true
        default: 'huihui-ai/Huihui-Qwen3-14B-abliterated-v2'
      image_tag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
      use_mirror:
        description: 'Use HuggingFace mirror (hf-mirror.com)'
        type: boolean
        default: false
  schedule:
    - cron: "0 */8 * * *"
  push:
    branches: [ main ]
    paths: [ 'Dockerfile', '.github/workflows/**' ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: seecsea/hf-qwen3

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dummy: [1]

    steps:
    - name: List disk info
      run: |
        echo "==> All disk info is"
        sudo lsblk
        sudo df -h
    
    - name: Maximize build space
      uses: AdityaGarg8/remove-unwanted-software@v5
      with:
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        remove-large-packages: 'true'
        remove-cached-tools: 'true'
        remove-swapfile: 'true'
    
    - name: Stop Docker and move data directory to /mnt
      run: |
        echo "==> Stopping Docker service"
        sudo systemctl stop docker
        sudo systemctl stop docker.socket
        
        echo "==> Creating new Docker data directory in /mnt"
        sudo mkdir -p /mnt/docker-data
        
        echo "==> Moving existing Docker data (if any)"
        if [ -d "/var/lib/docker" ]; then
          sudo mv /var/lib/docker/* /mnt/docker-data/ 2>/dev/null || true
        fi
        
        echo "==> Configuring Docker daemon to use /mnt/docker-data"
        sudo mkdir -p /etc/docker
        sudo tee /etc/docker/daemon.json > /dev/null <<EOF
        {
          "data-root": "/mnt/docker-data",
          "storage-driver": "overlay2"
        }
        EOF
        
        echo "==> Starting Docker service"
        sudo systemctl start docker
        
        echo "==> Verifying new configuration"
        docker info | grep "Docker Root Dir"
        
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ vars.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Generate image metadata
      id: meta
      run: |
        MODEL_NAME="${{ github.event.inputs.model_name || 'huihui-ai/Huihui-Qwen3-14B-abliterated-v2' }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag || 'latest' }}"
        
        echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
        # åªç”Ÿæˆä¸€ä¸ªæ ‡ç­¾
        FULL_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
        echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
        
        # è®¾ç½® HuggingFace ç«¯ç‚¹
        if [ "${{ github.event.inputs.use_mirror }}" = "true" ]; then
          echo "hf_endpoint=https://hf-mirror.com" >> $GITHUB_OUTPUT
        else
          echo "hf_endpoint=https://huggingface.co" >> $GITHUB_OUTPUT
        fi

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64  # åªæž„å»º amd64 æž¶æž„
        push: true
        tags: ${{ steps.meta.outputs.full_tag }}  # åªä½¿ç”¨ä¸€ä¸ªæ ‡ç­¾
        build-args: |
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          MODEL_NAME=${{ steps.meta.outputs.model_name }}
          HF_ENDPOINT=${{ steps.meta.outputs.hf_endpoint }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test image
      run: |
        echo "Testing the built image..."
        docker run --rm ${{ steps.meta.outputs.full_tag }}

    - name: Generate summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Model Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Model**: \`${{ steps.meta.outputs.model_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
        echo "- **Base Image**: python:3.12.12-slim-trixie" >> $GITHUB_STEP_SUMMARY
        echo "- **Mirror**: ${{ steps.meta.outputs.hf_endpoint }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta.outputs.full_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Usage Examples" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Quick Extract" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Pull and extract model files" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ steps.meta.outputs.full_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "docker create --name temp-model ${{ steps.meta.outputs.full_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "docker cp temp-model:/models ./local-models" >> $GITHUB_STEP_SUMMARY
        echo "docker rm temp-model" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### View Model Info" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker run --rm ${{ steps.meta.outputs.full_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
